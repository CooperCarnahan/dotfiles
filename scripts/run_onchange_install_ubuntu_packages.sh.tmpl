{{- if and (eq .osid "linux-ubuntu") -}}
#!/bin/bash
set -euo pipefail

# Define color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
  echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Install mise if not already installed
install_mise() {
  if ! command_exists mise; then
    log_info "Installing mise..."
    curl https://mise.run | sh
    
    if [ $? -ne 0 ]; then
      log_error "Failed to install mise"
      exit 1
    fi
    
    # Add mise to PATH for current session
    export PATH="$HOME/.local/bin:$PATH"
    log_success "mise installed"
  else
    log_info "mise already installed"
    mise --version
  fi
}

# Upgrade mise-installed tools
upgrade_mise_tools() {
  log_info "Upgrading packages installed via mise"
  read -p "Do you want to upgrade all mise-installed tools automatically? (Y/n): " -r
  echo
  if [[ $REPLY =~ ^[Nn]$ ]]; then
    mise upgrade --interactive --bump
  else
    mise upgrade --bump
  fi
  mise install
  log_success "mise tools upgraded"
}

# Install apprise via uv
install_apprise() {
  if ! command_exists apprise; then
    log_info "Installing Apprise via uv..."
    uv tool install apprise --python 3.12
    log_success "Apprise installed"
  else
    log_info "Apprise already installed"
    apprise --version
  fi
}

# Install system dependencies
install_dependencies() {
  log_info "Installing system dependencies..."
  
  # Install software-properties-common first (needed for add-apt-repository)
  sudo apt-get update
  sudo apt-get install -y software-properties-common
  
  # Add Git PPA and install latest Git
  log_info "Installing latest Git version..."
  sudo add-apt-repository -y ppa:git-core/ppa
  sudo apt-get update
  sudo apt-get install -y git
  git_version=$(git --version | awk '{print $3}')
  log_success "Latest Git version $git_version installed"
  
  # Install other dependencies
  sudo apt-get install -y build-essential cmake pkg-config libfreetype6-dev libfontconfig1-dev \
    libxcb-xfixes0-dev libxkbcommon-dev python3 curl unzip gettext libtool libtool-bin \
    autoconf automake ninja-build g++ pkg-config libssl-dev python3-pip python3-pynvim python3-venv
  
  log_success "System dependencies installed"
}

main() {
  log_info "Starting installation process..."

  install_dependencies
  install_mise
  upgrade_mise_tools
  install_apprise

  log_success "All installations complete!"
  log_info "Please restart your terminal or run 'source ~/.profile' to apply all changes."
}

main
{{- end }}
