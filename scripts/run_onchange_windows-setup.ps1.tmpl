# win_configuration.winget hash: {{ include "windows_config.winget" | sha256sum }}
# This script consolidates Windows setup logic: WinGet Configuration and Scoop

$ErrorActionPreference = 'Continue'
$ProgressPreference = 'SilentlyContinue'

function Write-Step {
    param([string]$Message)
    Write-Host "`n==> $Message" -ForegroundColor Cyan
}

function Refresh-SessionEnvironment {
    Write-Host "Refreshing environment variables from registry..." -ForegroundColor Gray
    
    # Reload Path from Registry (Machine and User)
    $machinePath = [System.Environment]::GetEnvironmentVariable("Path", "Machine")
    $userPath = [System.Environment]::GetEnvironmentVariable("Path", "User")
    $env:Path = "$machinePath;$userPath"
    
    # Manual fallback for Git if WinGet just installed it but it's not yet in the session path
    if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
        $gitPath = "C:\Program Files\Git\cmd"
        if (Test-Path $gitPath) {
            Write-Host "Manually adding Git to session path..." -ForegroundColor Gray
            $env:Path += ";$gitPath"
        }
    }
}

# 1. Declarative Configuration (WinGet)
# We do this first to enable Features (WSL) and set global Paths/Environment.
Write-Step "Applying WinGet Configuration"
$configFile = Join-Path "{{ .chezmoi.sourceDir }}" "win_configuration.winget"

if (Get-Command winget -ErrorAction SilentlyContinue) {
    & winget configure --file "$configFile" --accept-configuration-agreements
    
    # Refresh the current session's PATH so subsequent steps see the new global variables and installed tools (like Git)
    Refresh-SessionEnvironment
} else {
    Write-Warning "WinGet not found. Skipping declarative configuration."
}

# 2. Scoop Setup
Write-Step "Checking Scoop installation"
if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Scoop..."
    Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
}

# Ensure Git is available for Scoop buckets (Scoop won't add buckets without it)
if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
    Write-Warning "Git not found. Scoop bucket operations may fail."
}

$ScoopBuckets = @('extras', 'nerd-fonts')
foreach ($Bucket in $ScoopBuckets) {
    scoop bucket add $Bucket 2>$null
}

Write-Step "Installing Scoop-only Packages (Fonts)"
$ScoopPackages = @('nerd-fonts/CascadiaCode-NF', 'nerd-fonts/Maple-Mono-NF', 'ouch', 'tree-sitter')
foreach ($Package in $ScoopPackages) {
    scoop install $Package
}

Write-Host "`nWindows Setup Completed!" -ForegroundColor Green
