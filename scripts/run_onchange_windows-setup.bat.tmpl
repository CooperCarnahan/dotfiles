{{- if eq .chezmoi.os "windows" -}}
@echo off
set "SOURCE_DIR={{ .chezmoi.sourceDir }}"
set "CONFIG_FILE=%SOURCE_DIR%\win_configuration.winget"

echo ==> Applying WinGet Configuration...
:: WinGet configure handles its own environment and the DSC manifest handles registry states.
winget configure --file "%CONFIG_FILE%" --accept-configuration-agreements --accept-source-agreements

echo ==> Setting up Scoop and Fonts...
:: We use Bypass here so this specific command works regardless of the current system policy.
:: The permanent policy is set to RemoteSigned in the WinGet manifest above.
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
    "if (!(Get-Command scoop -ErrorAction SilentlyContinue)) { iwr -useb get.scoop.sh | iex }; ^
     scoop bucket add extras 2>$null; scoop bucket add nerd-fonts 2>$null; ^
     scoop install nerd-fonts/CascadiaCode-NF nerd-fonts/Maple-Mono-NF ouch"

echo ==> Ensuring Ubuntu distribution is installed...
wsl --install -d Ubuntu --web-download

echo ==> Setting up Apprise via UV (Mise)...
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
    "$env:Path = [System.Environment]::GetEnvironmentVariable('Path', 'Machine') + ';' + [System.Environment]::GetEnvironmentVariable('Path', 'User'); ^
     function Get-UVPath { ^
         $misePaths = @(\"$env:USERPROFILE\.local\bin\mise.exe\", \"$env:LOCALAPPDATA\bin\mise.exe\", (Get-Command mise -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)); ^
         foreach ($path in $misePaths) { if (Test-Path $path) { $uvBin = & $path where uv 2>$null; if ($uvBin -and (Test-Path $uvBin)) { return $uvBin } } } ^
         return $null; ^
     }; ^
     $uvPath = Get-UVPath; ^
     if ($null -ne $uvPath) { & $uvPath tool install apprise --python 3.12 } else { ^
         if (!(Get-Command uv -ErrorAction SilentlyContinue)) { scoop install uv }; ^
         uv tool install apprise --python 3.12 ^
     }"

echo ==> Windows Setup Completed!
{{- end -}}
