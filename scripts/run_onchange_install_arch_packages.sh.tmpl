{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e

# Use Chezmoi's template variables to check the OS ID.
{{- if or (eq .osid "linux-arch") (eq .osid "linux-cachyos") -}}

echo "--- Detected supported OS: {{ .osid }} ---"

# --- Configuration ---
# Packages to install from the official Arch repositories
pacman_packages=(
    "atuin"
    "bat"
    "base"
    "base-devel"
    "ccache"
    "chezmoi"
    "cmake"
    "croc"
    "ctags"
    "difftastic"
    "dfu-util"
    "docker"
    "docker-compose"
    "dtc"
    "fastfetch"
    "fd"
    "fzf"
    "ghostty"
    "git"
    "git-delta"
    "go"
    "gperf"
    "jujutsu"
    "lazygit"
    "make"
    "mise"
    "neovim"
    "ninja"
    "nodejs"
    "npm"
    "nushell"
    "openssh"
    "python-pip"
    "python-setuptools"
    "python-wheel"
    "ripgrep"
    "rust"
    "starship"
    "sudo"
    "tk"
    "tmux"
    "tree"
    "tree-sitter-cli"
    "unzip"
    "uv"
    "wget"
    "which"
    "yazi"
    "zellij"
    "zen-browser-bin"
    "zoxide"
)

# Packages to install from the Arch User Repository (AUR)
aur_packages=(
    "1password"
    "carapace-bin"
    "gearlever"
    "git-credential-manager-bin"
    "gnome-browser-connector"
    "maplemono-nf-unhinted"
    "tlp"
    "tlpgui"
    "vicinae"
    "opencode"
    "ov"
    "winboat-bin"
)

# --- Functions ---
# A function to check if a command exists
command_exists () {
    command -v "$1" >/dev/null 2>&1
}

# --- Script Execution ---

echo "--- System Information ---"
os_info=$(cat /etc/os-release 2>/dev/null | grep "^NAME=" | cut -d'=' -f2 | tr -d '"')
kernel_version=$(uname -r)

echo "Operating System: $os_info"
echo "Kernel Version: $kernel_version"

echo "--------------------------"
echo "--- Installing/updating essential packages via pacman ---"

# Check if pacman is installed before proceeding.
if ! command_exists "pacman"; then
    echo "Error: pacman not found. This script is for Arch-based systems."
    exit 1
fi

# Update system and install official packages.
# --noconfirm: Assumes 'yes' to all prompts.
# --needed: Skips packages that are already installed.
sudo pacman -Syu --noconfirm --needed "${pacman_packages[@]}"

# Check for paru and install it if it's missing.
if ! command_exists "paru"; then
    # Temporarily clone and install paru from the AUR
    # It's important to use a temporary directory for this.
    cd /tmp
    git clone https://aur.archlinux.org/paru.git
    cd paru
    makepkg -si --noconfirm
    
    # Clean up temporary files
    cd ~
    rm -rf "/tmp/paru"
fi

echo "--- Installing/updating AUR packages via paru ---"

# Install AUR packages.
paru -S --noconfirm --needed "${aur_packages[@]}"

echo "--- Installing Apprise via uv ---"
uv tool install apprise --python 3.12

echo "--- All packages installed successfully! ---"

fastfetch

{{- else -}}
echo "Unsupported OS: {{ .osid }}. Skipping package installation."
echo "This script is only for Arch-based systems."
{{- end -}}
{{- end -}}
